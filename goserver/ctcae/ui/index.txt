<!doctype html>
<meta charset="utf-8" />
<title>CTCAE Helper</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<style>
  body { font-family: sans-serif; max-width: 900px; margin: 24px auto; }
  textarea { width: 100%; height: 12em; }
  button { padding: 8px 14px; }
  pre { background: #f7f7f7; padding: 12px; white-space: pre-wrap; }
  .status { padding: 6px 10px; border: 1px solid #ccc; margin-bottom: 10px; }
</style>

<h1>CTCAE 評価デモ</h1>

<div id="status" class="status">API接続判定中…</div>

<p>検査結果を貼り付けて「評価」ボタンを押してください。</p>
<textarea id="input" placeholder="例:
001 Hb. 10.1
002 AST. 12
"></textarea><br/><br/>
<button id="btn-eval">評価</button>

<h3>結果</h3>
<pre id="out">(未評価)</pre>

<script>
// 同一オリジン配信なので CORS は不要。/health で簡易判定
(function(){
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/health', true);
  xhr.onreadystatechange = function(){
    if (xhr.readyState === 4) {
      var ok = (xhr.status >= 200 && xhr.status < 300 && /"ok"\s*:\s*true/.test(xhr.responseText||""));
      var st = document.getElementById('status');
      if (ok) {
        st.textContent = 'ローカルAPIに接続しています。';
        st.style.background = '#e6ffea'; st.style.borderColor = '#2ea043';
      } else {
        st.textContent = 'ローカルAPIに接続できません。ctcae.exe を起動してください。';
        st.style.background = '#ffecec'; st.style.borderColor = '#d1242f';
      }
    }
  };
  try { xhr.send(); } catch(e) {}
})();

document.getElementById('btn-eval').onclick = function(){
  var txt = document.getElementById('input').value || '';
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/api/evaluate', true);
  xhr.setRequestHeader('Content-Type','application/json');
  xhr.onreadystatechange = function(){
    if (xhr.readyState === 4) {
      var out = document.getElementById('out');
      try {
        var res = JSON.parse(xhr.responseText);
        var lines = (res.items||[]).map(function(it){
          return it.code + ' ' + it.value + ': ' + (it.grade || '(N/A)');
        });
        out.textContent = lines.join('\n') || '(該当なし)';
      } catch (e) {
        out.textContent = 'エラー: ' + e;
      }
    }
  };
  try {
    xhr.send(JSON.stringify({text: txt}));
  } catch(e) {
    document.getElementById('out').textContent = '送信に失敗しました: ' + e;
  }
};
</script>
